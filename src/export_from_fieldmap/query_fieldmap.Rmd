---
title: "Export data from fieldmap database: heath habitat types, habitat type 6510, and forest habitat types"
date: "`r lubridate::now()`"
output: 
  html_document:
    number_sections: yes
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(RODBC)
library(kableExtra)
library(DT)
library(n2khab)
library(git2rdata)

```

# Database names

The fieldmap databases can be found in [this google drive folder](https://drive.google.com/open?id=1hbPkVXvpL0qACXmqLDxQPs1XRBaSeg5l&authuser=toon.westra%40inbo.be&usp=drive_fs). The latetst version of the databases should be copied to the local project folder `n2khab-mhq-data/raw`.

An overview of the different versions of the fieldmap databases can be found in [this google sheet](https://docs.google.com/spreadsheets/d/1Ty_xH0hGVhVgAxZDAah3hsxXkdgmcdWhQZQY5AfUskM/edit#gid=0). 


```{r dbINBO}

db_fieldmap_foresthab_past2020 <- file.path(fileman_up("n2khab-mhq-data"), "raw/fieldmap_foresthab/fieldmap_foresthab_v2023.FDB")
db_fieldmap_foresthab <- file.path(fileman_up("n2khab-mhq-data"), "raw/fieldmap_foresthab/fieldmap_foresthab_v2020.FDB")
db_fieldmap_openhab <- file.path(fileman_up("n2khab-mhq-data"), "raw/fieldmap_openhab/fieldmap_openhab_v7.FDB")

# check if database is in project folder

if (!file.exists(db_fieldmap_foresthab)) {
  
  stop(cat("Fieldmap database for forest habitat types not found."))
  
}

if (!file.exists(db_fieldmap_openhab)) {
  
  stop(cat("Fieldmap database for open habitat types not found."))
  
}

```


```{r dbANB, eval = FALSE}
#In formaat, compatibel met FM
db_fieldmap_foresthab <- "../../data/database_forest_2021-03-30/BOSHAB_F_v2020_MASTER/FIELDMAPDATA_BOSHAB_F_V2020_MASTER.FDB"
db_fieldmap_openhab <- "../../data/database_heath6510_2021-03-30/MASTER_NAT2000_F_V7/FIELDMAPDATA_MASTER_NAT2000_F_V7.FDB"
```

# Functions for querying the database

## Scales used for vegetation assessments

```{r scales}

scales_orig <- read_csv2(file.path(fileman_up("n2khab-mhq-data"), "metadata/cover_scales.csv"))

coverscales <- scales_orig %>%
    rename(coverscale_name = Schaal,
           class_id = KlasseID,
           class_code = KlasseCode,
           cover_description = KlasseBeschrijving,
           cover_mean = BedekkingGem,
           cover_min = BedekkingMin,
           cover_max = BedekkingMax) %>%
    mutate(class_code = ifelse(class_code == "", NA, class_code))

#write_vc(scales, file = "coverscales_mhq", root = "../../data", sorting = c("coverscale_name", "class_id"), strict = FALSE)
```


## Functions to access open habitat fieldmap database


```{r v7_getaccessOpenHabFMdb}

# targethabitat : doelhabitat waargenomen on field of niet
# status_fieldwork : INVAV : er is een opname gedaan (volledig of gedeeltelijk) of niet
# info_status_fieldwerk : detail over al dan niet opname (bv geen opname want niet toeg, of omdat er geen nodig was)

get_status_openhab <- function(db = db_fieldmap_openhab){

query_gridpoints <- "SELECT Grid_points.IDPlots as navplot_id,
    Grid_points.Ranking as plot_id,
    Grid_points.Add_date as date_status,
    Grid_points.SingleID as sampling_unit_code,
    YesNo.Value1 as TargetHabitat,
    QINVAV.Value1 as status_fieldwork,
    QINVAV_EXTRA.Value1 as info_status_fieldwork,
    Grid_points.Remark as remark
    FROM Grid_points 
    LEFT JOIN qFieldteam ON Grid_points.Fieldteam = qFieldteam.ID
    LEFT JOIN QINVAV_EXTRA ON Grid_points.INFO_STATUS_FIELDWORK = QINVAV_EXTRA.ID
    LEFT JOIN QINVAV ON Grid_points.INVAVAILABLE = QINVAV.ID
    LEFT JOIN YesNo ON Grid_points.TARGETHABITAT = YesNo.ID;"

  if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

 gridpoints_orig <- sqlQuery(connect_db, query_gridpoints)
 
 colnames(gridpoints_orig) <- str_to_lower(colnames(gridpoints_orig))
 
 # selectie van punten die zijn afgewerkt v5--status_fw = afgewerkt (ja/nee) --> v7 Info_status_fieldwerk : opname volledig/gedeeltelijk/niet afgewerkt
 gridpoints <- gridpoints_orig %>%
    #filter(!is.na(status_fieldwork))
     filter(info_status_fieldwork != 'to do/geen reden/vergeten' & !is.na(info_status_fieldwork)) # 8 : to do/vergeten
  odbcClose(connect_db)

  return(gridpoints)
}

get_type_observed_openhab <- function(db = db_fieldmap_openhab){

  query_type_observed_circle <- "
  SELECT
  Standdescription.IDPlots as plot_id,
  Standdescription.ID as segment_id,
  Standdescription.Add_date as date_standdescription,
  Standdescription.Area_m2 as area_m2,
  qHABITAT.Value1 as type_observed_circle
  FROM Standdescription LEFT JOIN qHABITAT ON Standdescription.HABITAT = qHABITAT.ID;
  "
  
  query_type_observed_square <- "
  SELECT
  VegPQ.IDPlots as plot_id,
  qHABITAT.Value1 as type_observed_square
  FROM VegPQ LEFT JOIN qHABITAT ON VegPQ.HAB1 = qHABITAT.ID;
  "

  if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  type_observed_circle_orig <- sqlQuery(connect_db, query_type_observed_circle, stringsAsFactors = FALSE)
  type_observed_square_orig <- sqlQuery(connect_db, query_type_observed_square, stringsAsFactors = FALSE)
  
  odbcClose(connect_db)

  colnames(type_observed_circle_orig) <- str_to_lower(colnames(type_observed_circle_orig))
  colnames(type_observed_square_orig) <- str_to_lower(colnames(type_observed_square_orig))
  
  type_observed_square <- type_observed_square_orig %>%
      filter(!is.na(type_observed_square))
  
  type_observed <- type_observed_circle_orig %>%
    full_join(type_observed_square, by = c("plot_id")) %>%
    mutate(type_observed_circle = ifelse(nchar(type_observed_circle) %in% c(7, 8),
                                         gsub(" ", "_", type_observed_circle),
                                         type_observed_circle),
           type_observed_square = ifelse(nchar(type_observed_square) %in% c(7, 8),
                                         gsub(" ", "_", type_observed_square),
                                         type_observed_square))

  result <- type_observed

  return(result)
}

get_cover_veglayers_openhab <- function(db = db_fieldmap_openhab){

  query_cover_veglayers <- "
  SELECT
  VegPQ.IDPlots as plot_id,
  VegPQ.ID as segment_id,
  VegPQ.Licheneslayer,
  VegPQ.Sphagnumlayer,
  VegPQ.OtherMosslayer,
  VegPQ.Herblayer,
  VegPQ.Shrublayer,
  VegPQ.Treelayer,
  VegPQ.Shrub_and_Treelayer as shrub_treelayer,
  VegPQ.Litter
  FROM VegPQ;"

  if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  cover_veglayers_orig <- sqlQuery(connect_db, query_cover_veglayers, stringsAsFactors = FALSE)
  
  odbcClose(connect_db)

  colnames(cover_veglayers_orig) <- str_to_lower(colnames(cover_veglayers_orig))
  
  cover_veglayers <- cover_veglayers_orig %>%
    mutate(mosslayer = sphagnumlayer + othermosslayer) %>%
    gather(mosslayer, herblayer, shrublayer, treelayer, shrub_treelayer, licheneslayer, sphagnumlayer, othermosslayer, litter, key = "layer", value = "cover") %>%
    arrange(plot_id)

  return(cover_veglayers)

}


get_cover_species_openhab <- function(db = db_fieldmap_openhab){

  query_herblayer<-"
  SELECT Herblayer.IDPlots as plot_id,
  Herblayer.Species as name_id,
  qVEG_HerbSpecies.Value1 as name_nl,
  qVEG_HerbSpeciesScientific.Value1 as name_sc,
  Herblayer.Coverage_date1 as class_id,
  qLondo.Value1 as cover_description
  FROM Herblayer
  LEFT JOIN qVEG_HerbSpecies ON Herblayer.Species = qVEG_HerbSpecies.ID
  LEFT JOIN qVEG_HerbSpeciesScientific ON Herblayer.Species_scientific = qVEG_HerbSpeciesScientific.ID
  LEFT JOIN qLondo ON Herblayer.Coverage_date1 = qLondo.ID;
  "

  query_shrublayer <- "
  SELECT Shrublayer.IDPlots as plot_id,
  Shrublayer.Species as name_id,
  qVEG_TreeSpecies.Value1 as name_nl,
  qVEG_TreeSpeciesScientific.Value1 as name_sc,
  Shrublayer.Coverage as class_id,
  qLondo.Value1 as cover_description
  FROM Shrublayer
  LEFT JOIN qVEG_TreeSpecies ON Shrublayer.Species = qVEG_TreeSpecies.ID
  LEFT JOIN qVEG_TreeSpeciesScientific ON Shrublayer.Species_Scientific = qVEG_TreeSpeciesScientific.ID
  LEFT JOIN qLondo ON Shrublayer.Coverage = qLondo.ID;
  "

  query_treelayer <- "
  SELECT Treelayer.IDPlots as plot_id,
  Treelayer.Species as name_id,
  qVEG_TreeSpecies.Value1 as name_nl,
  qVEG_TreeSpeciesScientific.Value1 as name_sc,
  Treelayer.Coverage as class_id,
  qLondo.Value1 as cover_description
  FROM Treelayer
  LEFT JOIN qVEG_TreeSpecies ON Treelayer.Species = qVEG_TreeSpecies.ID
  LEFT JOIN qVEG_TreeSpeciesScientific ON Treelayer.Species_Scientific = qVEG_TreeSpeciesScientific.ID
  LEFT JOIN qLondo ON Treelayer.Coverage = qLondo.ID;
  "

  query_mosslayer <- "
  SELECT Mosslayer.IDPlots as plot_id,
  Mosslayer.Species as name_id,
  qVEG_MossSpecies.Value1 as name_nl,
  qVEG_MossSpeciesScientific.Value1 as name_sc,
  Mosslayer.Coverage as class_id,
  qLondo.Value1 as cover_description
  FROM Mosslayer
  LEFT JOIN qVEG_MossSpecies ON Mosslayer.Species = qVEG_MossSpecies.ID
  LEFT JOIN qVEG_MossSpeciesScientific ON Mosslayer.Species_Scientific = qVEG_MossSpeciesScientific.ID
  LEFT JOIN qLondo ON Mosslayer.Coverage = qLondo.ID;
  "

  if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  herblayer_orig <- sqlQuery(connect_db, query_herblayer, stringsAsFactors = FALSE)
  shrublayer_orig <- sqlQuery(connect_db, query_shrublayer, stringsAsFactors = FALSE)
  treelayer_orig <- sqlQuery(connect_db, query_treelayer, stringsAsFactors = FALSE)
  mosslayer_orig <- sqlQuery(connect_db, query_mosslayer, stringsAsFactors = FALSE)

  odbcClose(connect_db)

  colnames(herblayer_orig) <- str_to_lower(colnames(herblayer_orig))
  colnames(shrublayer_orig) <- str_to_lower(colnames(shrublayer_orig))
  colnames(treelayer_orig) <- str_to_lower(colnames(treelayer_orig))
  colnames(mosslayer_orig) <- str_to_lower(colnames(mosslayer_orig))
  
   herblayer <- herblayer_orig %>%
     mutate(layer = "herblayer")

   shrublayer <- shrublayer_orig %>%
     mutate(layer = "shrublayer")

   treelayer <- treelayer_orig %>%
     mutate(layer = "treelayer")

   mosslayer <- mosslayer_orig %>%
     mutate(layer = "mosslayer")

  # coverscales <- read_vc(file = "coverscales_mhq", root = "../../data")
   
  veglayers <- bind_rows(herblayer, shrublayer, treelayer, mosslayer) %>%
    filter(!is.na(name_id)) %>%
    mutate(coverscale_name = "Londo") %>%
    left_join(coverscales, by = c("coverscale_name", "class_id", "cover_description")) %>%
    select(plot_id, layer, name_nl, name_sc, coverscale_name, cover_description, cover_mean) %>%
    arrange(plot_id, layer, name_sc)
    
  return(veglayers)

}

get_measurements_heath_circle <- function(db = db_fieldmap_openhab){

  query_structurevar_heath <- "SELECT
  SiteDescription_HEIDE.IDPlots as plot_id,
  SiteDescription_HEIDE.IDSTANDDESCRIPTION as segment_id,
SiteDescription_HEIDE.Edit_date as date_sitedescription,
  SiteDescription_HEIDE.Shrub_and_Treelayer_18m,
  SiteDescription_HEIDE.Sphagnumlayer,
  SiteDescription_HEIDE.Campylopus_introflexus,
  SiteDescription_HEIDE.LowShrublayer,
  SiteDescription_HEIDE.Brushwood,
  SiteDescription_HEIDE.Herbs,
  SiteDescription_HEIDE.Calluna_phase_pioneer,
  SiteDescription_HEIDE.Calluna_phase_devel,
  SiteDescription_HEIDE.Calluna_phase_climax,
  SiteDescription_HEIDE.Calluna_phase_degen,
  SiteDescription_HEIDE.Pioneer_phase_open_soil,
  SiteDescription_HEIDE.Pioneer_Coryn_Aira,
  SiteDescription_HEIDE.Pioneer_Mos,
  SiteDescription_HEIDE.Pioneer_Lichenen
  FROM SiteDescription_HEIDE;"
  
  query_bms <- "SELECT
  QBMS.ID as class_id,
  QBMS.VALUE1 as cover_description
  FROM QBMS;"
  

  if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  structure_vars <- sqlQuery(connect_db, query_structurevar_heath, stringsAsFactors = FALSE)
  
  bms <- sqlQuery(connect_db, query_bms, stringsAsFactors = FALSE)

  odbcClose(connect_db)
  
  colnames(structure_vars) <- str_to_lower(colnames(structure_vars))
  colnames(bms) <- str_to_lower(colnames(bms))
  
  bms2 <- bms %>%
    separate(col = "cover_description", into = c("class_code", "cover_description")  ,sep = " - ") %>%
    mutate(class_code = ifelse(class_code == "KW", "KB", class_code)) %>% # aanpassen in databank
    left_join(select(coverscales, class_code, cover_mean), by = "class_code") # cover_mean toevoegen aan databank

# uitgezonderd bedekking van struik+boomlaag worden alle bedekkingen via BMS-schaal bepaald
  structure_var_bms <- structure_vars %>%
    select(-shrub_and_treelayer_18m) %>%
    gather(-plot_id, - segment_id, -date_sitedescription, key = "structure_var", value = "class_id") %>%
    mutate(coverscale_name = "Beheermonitoringsschaal") %>%
      left_join(bms2, by = c("class_id")) %>%
      select(plot_id, segment_id, structure_var, coverscale_name, cover_description, cover_mean) %>%
      mutate(structure_var = tolower(structure_var))
  
  structure_var_cover <- structure_vars %>%
      mutate(structure_var = "shrub_treelayer") %>%
      select(plot_id, segment_id, structure_var, cover = shrub_and_treelayer_18m)
      

# alle records als bedekking uitgedrukt
  structure_vars_long <- bind_rows(structure_var_bms,
                                   structure_var_cover) %>%
      arrange(plot_id, segment_id, structure_var)

  return(structure_vars_long)

}


get_measurements_heath_circle_old <- function(db = db_fieldmap_openhab){

  query_structurevar_heath<- "SELECT
  SiteDescription_HEIDE.IDPlots as plot_id,
  SiteDescription_HEIDE.Shrub_and_Treelayer_18m,
  SiteDescription_HEIDE.Sphagnumlayer,
  SiteDescription_HEIDE.Campylopus_introflexus,
  SiteDescription_HEIDE.LowShrublayer,
  SiteDescription_HEIDE.Brushwood,
  SiteDescription_HEIDE.Herbs,
  SiteDescription_HEIDE.Calluna_phase_pioneer,
  SiteDescription_HEIDE.Calluna_phase_devel,
  SiteDescription_HEIDE.Calluna_phase_climax,
  SiteDescription_HEIDE.Calluna_phase_degen,
  SiteDescription_HEIDE.Pioneer_phase_open_soil,
  SiteDescription_HEIDE.Pioneer_Coryn_Aira,
  SiteDescription_HEIDE.Pioneer_Mos,
  SiteDescription_HEIDE.Pioneer_Lichenen
  FROM SiteDescription_HEIDE;"
  

  if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  structure_vars <- sqlQuery(connect_db, query_structurevar_heath, stringsAsFactors = FALSE)

  odbcClose(connect_db)
  
  #coverscales <- read_vc(file = "coverscales_mhq", root = "../../data")
  
# uitgezonderd bedekking van struik+boomlaag worden alle bedekkingen via tansley-schaal bepaald
  structure_var_tansley <- structure_vars %>%
    select(plot_id, LowShrublayer, starts_with("Calluna")) %>%
    gather(-plot_id, key = "structure_var", value = "class_id") %>%
    mutate(coverscale_name = "Tansley") %>%
    left_join(coverscales, by = c("coverscale_name","class_id")) %>%
    select(plot_id, structure_var, coverscale_name, cover_description, cover_mean) %>%
    mutate(structure_var = tolower(structure_var))
  
  structure_var_cover <- structure_vars %>%
    select(-LowShrublayer, -starts_with("Calluna")) %>%
    gather(-plot_id, key = "structure_var", value = "cover")
      

# alle records als bedekking uitgedrukt
  structure_vars_long <- bind_rows(structure_var_tansley,
                                   structure_var_cover) %>%
      arrange(plot_id, structure_var)

  return(structure_vars_long)

}


get_measurements_6510_circle <- function(db = db_fieldmap_openhab){

  query_StructurePlot6510 <- "SELECT
  SiteDescription_6510.IDPlots as plot_id,
  SiteDescription_6510.Shrub_and_Treelayer_18m
  FROM SiteDescription_6510"

   if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  structure_vars_orig <- sqlQuery(connect_db, query_StructurePlot6510)

  odbcClose(connect_db)
  
  colnames(structure_vars_orig) <- str_to_lower(colnames(structure_vars_orig))
  
  structure_vars <- structure_vars_orig %>%
      mutate(structure_var = "shrub_treelayer") %>%
      select(plot_id , structure_var, cover = shrub_and_treelayer_18m)
      
  
  return(structure_vars)
}

get_date_openhab <- function(db = db_fieldmap_openhab){

  query_date <- "SELECT
  Observer_date.IDPlots as plot_id,
  Observer_date.Add_date as date_assessment
  FROM Observer_date"

   if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  date_assessments_orig <- sqlQuery(connect_db, query_date)
  
  odbcClose(connect_db)
  
  colnames(date_assessments_orig) <- str_to_lower(colnames(date_assessments_orig))
  
  date_assessments <- date_assessments_orig %>%
      mutate(date_assessment = as.Date(date_assessment, format = "%Y-%m-%d"))
      
  return(date_assessments)
}

get_coordinates_openhab <- function(db = db_fieldmap_openhab){

  query_coord <- "SELECT
  GPS_REF.IDPlots,
  GPS_REF.SingleID as plot_id,
  GPS_REF.X_m as x_measured,
  GPS_REF.Y_m as y_measured
  FROM GPS_REF"

    if (str_sub(db, nchar(db) - 3, nchar(db)) == ".mdb") {
    connect_db <-   odbcConnectAccess(db)
  } else if (str_sub(db, nchar(db) - 5, nchar(db)) == ".accdb") {
    connect_db <-   odbcConnectAccess2007(db)
  } else if (str_sub(db, nchar(db) - 3, nchar(db)) == ".FDB") {
    connect_db <-   odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  }

  coordinates <- sqlQuery(connect_db, query_coord) %>%
      filter(!is.na(PLOT_ID))

  odbcClose(connect_db)
  
  colnames(coordinates) <- str_to_lower(colnames(coordinates))
  
  return(coordinates)
}

```


## Functions to access forest hab fieldmap database

```{r AccessForest}

get_status_foresthab <- function(db = db_fieldmap_foresthab){

query_status <- "SELECT G.idplots as navplot_id,
        G.plot_id, 
        G.edit_date AS date_status,
        G.status_fieldwork,
        Q.value1 AS info_status_fieldwork,
        G.veg_done, 
        G.reg_done, 
        G.dendro_done, 
        G.info_springveg, 
        G.springveg, 
        G.remark, 
        G.remark4 
        FROM grid_points G
        LEFT JOIN qinfo_status_fieldwork Q ON G.info_status_fieldwork = Q.id"    

connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

gridpoints_orig <- sqlQuery(connect_db, query_status)
colnames(gridpoints_orig) <- str_to_lower(colnames(gridpoints_orig))

gridpoints <- gridpoints_orig %>%
    filter(!is.na(status_fieldwork)) %>%
    mutate(status_fieldwork = ifelse(status_fieldwork == 2, "nee", 
                                     ifelse(status_fieldwork == 1, "ja", "onbepaald")))

odbcClose(connect_db)

return(gridpoints)
}

get_type_observed_foresthab <- function(db = db_fieldmap_foresthab){

  query_type_observed <- "
  SELECT Standdescription_segments.IDPlots as plot_id,
  Standdescription_segments.ID as segment_id,
  Standdescription_segments.Area_m2,
  Standdescription_segments.Add_date as date_standdescription,
  qHABITAT.Value1 as type_observed_circle,
  qLanduse.Value1 as landuse
  FROM Standdescription_segments 
  LEFT JOIN qHABITAT ON Standdescription_segments.HAB = qHABITAT.ID 
  LEFT JOIN qLanduse ON Standdescription_segments.Landuse = qLanduse.ID;
  "

 connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

 type_observed_orig <- sqlQuery(connect_db, query_type_observed, stringsAsFactors = FALSE)

  odbcClose(connect_db)

  colnames(type_observed_orig) <- str_to_lower(colnames(type_observed_orig))
  
  type_observed <- type_observed_orig %>%
    mutate(type_observed_circle = ifelse(nchar(type_observed_circle) %in% c(7, 8),
                                         gsub(" ", "_", type_observed_circle),
                                         type_observed_circle))

  result <- type_observed

  return(result)
}

get_cover_veglayers_foresthab <- function(db = db_fieldmap_foresthab){

  query_veglayers <- "SELECT
  Vegetation.IDPlots as plot_id,
  Vegetation.ID as segment_id,
  Vegetation.Total_herb_cover as herblayer,
  Vegetation.Total_moss_cover as mosslayer,
  Vegetation.Total_shrub_cover as shrublayer,
  Vegetation.Total_tree_cover as treelayer
  FROM Vegetation;"

  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  veglayers_orig <- sqlQuery(connect_db, query_veglayers, stringsAsFactors = FALSE)

  odbcClose(connect_db)

  colnames(veglayers_orig) <- str_to_lower(colnames(veglayers_orig))
  
  #coverscales <- read_vc(file = "coverscales_mhq", root = "../../data")
  
  veglayers <- veglayers_orig %>%
    gather(herblayer, shrublayer, treelayer, mosslayer, key = "layer", value = "class_id") %>%
    mutate(coverscale_name = "CoverVeglayers") %>%
    left_join(coverscales, by = c("coverscale_name", "class_id")) %>%
    select(plot_id, segment_id, layer, cover_description, cover_mean) %>%
    arrange(plot_id, segment_id) 
  
  return(veglayers)

}

get_cover_species_foresthab <- function(db = db_fieldmap_foresthab){

  query_herblayer<-"SELECT Herblayer.IDPlots as plot_id,
  Herblayer.Species as name_id,
  qVEG_HerbSpecies.Value1 as name_nl,
  qVEG_HerbSpeciesScientific.Value1 as name_sc,
  Herblayer.Coverage_date1 as class_id
  FROM Herblayer
  LEFT JOIN qVEG_HerbSpecies ON Herblayer.Species = qVEG_HerbSpecies.ID
  LEFT JOIN qVEG_HerbSpeciesScientific ON Herblayer.Species_scientific = qVEG_HerbSpeciesScientific.ID;
  "

  query_shrublayer <- "
  SELECT Shrublayer.IDPlots as plot_id,
  Shrublayer.Species as name_id,
  qVEG_TreeSpecies.Value1 as name_nl,
  qVEG_TreeSpeciesScientific.Value1 as name_sc,
  Shrublayer.Coverage as class_id
  FROM Shrublayer
  LEFT JOIN qVEG_TreeSpecies ON Shrublayer.Species = qVEG_TreeSpecies.ID
  LEFT JOIN qVEG_TreeSpeciesScientific ON Shrublayer.Species_Scientific = qVEG_TreeSpeciesScientific.ID;
  "

  query_treelayer <- "
  SELECT Treelayer.IDPlots as plot_id,
  Treelayer.Species as name_id,
  qVEG_TreeSpecies.Value1 as name_nl,
  qVEG_TreeSpeciesScientific.Value1 as name_sc,
  Treelayer.Coverage as class_id
  FROM Treelayer
  LEFT JOIN qVEG_TreeSpecies ON Treelayer.Species = qVEG_TreeSpecies.ID
  LEFT JOIN qVEG_TreeSpeciesScientific ON Treelayer.Species_Scientific = qVEG_TreeSpeciesScientific.ID;
  "
  
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  herblayer_orig <- sqlQuery(connect_db, query_herblayer, stringsAsFactors = FALSE)
  shrublayer_orig <- sqlQuery(connect_db, query_shrublayer, stringsAsFactors = FALSE)
  treelayer_orig <- sqlQuery(connect_db, query_treelayer, stringsAsFactors = FALSE)

  odbcClose(connect_db)

   herblayer <- herblayer_orig %>%
     mutate(layer = "herblayer")

   shrublayer <- shrublayer_orig %>%
     mutate(layer = "shrublayer")

   treelayer <- treelayer_orig %>%
     mutate(layer = "treelayer")

  #coverscales <- read_vc(file = "coverscales_mhq", root = "../../data")
   
  veglayers <- bind_rows(herblayer, shrublayer, treelayer) 
  
  colnames(veglayers) <- str_to_lower(colnames(veglayers))
  
  veglayers <- veglayers %>%
    filter(!is.na(name_id)) %>%
    mutate(coverscale_name = "Braun-Blanquet") %>%
    left_join(coverscales, by = c("coverscale_name", "class_id")) %>%
    select(plot_id, layer, name_nl, name_sc, coverscale_name, cover_description, cover_mean) %>%
    arrange(plot_id, layer, name_sc)
    
  return(veglayers)

}

get_date_foresthab <- function(db = db_fieldmap_foresthab){

  query_date_veg <- "SELECT
  IDPlots as plot_id,
  date_vegetation
  FROM Observer_date_veg"
  
   query_date_dendro <- "SELECT
  Observer_date_dendro.IDPlots as plot_id,
  Observer_date_dendro.date_dendro
  FROM Observer_date_dendro"

  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  observer_date_veg <- sqlQuery(connect_db, query_date_veg)
  observer_date_dendro <- sqlQuery(connect_db, query_date_dendro)

  odbcClose(connect_db)
  
  observer_date <- observer_date_veg %>%
      full_join(observer_date_dendro, by =  "PLOT_ID")
  
  colnames(observer_date) <- str_to_lower(colnames(observer_date))
  
  observer_date_1 <- observer_date %>%
      group_by(plot_id) %>%
      summarise(n = n(),
                date_vegetation = as.Date(ifelse(n() > 1, min(date_vegetation, na.rm = TRUE), date_vegetation)),
                date_dendro = as.Date(ifelse(n() > 1, min(date_dendro, na.rm = TRUE), date_dendro))) %>%
      ungroup()
  
  return(observer_date_1)
}

get_coordinates_foresthab <- function(db = db_fieldmap_foresthab){

  query_coord <- "SELECT
  Plots_Forest_Inventory.IDPlots,
  Plots_Forest_Inventory.Plotnr as plot_id,
  Plots_Forest_Inventory.X_m as x_measured,
  Plots_Forest_Inventory.Y_m as y_measured
  FROM Plots_Forest_Inventory"
  
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  coordinates <- sqlQuery(connect_db, query_coord) %>%
      filter(!is.na(PLOT_ID))
  
  colnames(coordinates) <- str_to_lower(colnames(coordinates))

  odbcClose(connect_db)
  
  return(coordinates)
}

get_treesa3a4_raw <- function(db = db_fieldmap_foresthab){

  query_trees <- "
  SELECT Trees_2eBosinv.IDPlots as plot_id,
  Trees_2eBosinv.IDSegment as segment_id,
  Trees_2eBosinv.ID as tree_id,
  Trees_2eBosinv.Perimeter_cm,
  Trees_2eBosinv.DBH_mm,
  Trees_2eBosinv.Height_m,
  qTreeSpecies.Value1 as name_nl,
  qStatusTree.Value1 as status_tree,
  qCoppice_Individual.Value1 as coppice_individual,
  qIntactTree.Value1 as intact_tree
  FROM Trees_2eBosinv 
  LEFT JOIN qTreeSpecies ON Trees_2eBosinv.Species = qTreeSpecies.ID
  LEFT JOIN qStatusTree ON Trees_2eBosinv.Status_tree = qStatusTree.ID
  LEFT JOIN qCoppice_Individual ON Trees_2eBosinv.CodeCoppice_Individual = qCoppice_Individual.ID
  LEFT JOIN qIntactTree ON Trees_2eBosinv.IntactTree = qIntactTree.ID;
  "

  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  
  treesa3a4 <- sqlQuery(connect_db, query_trees, stringsAsFactors = FALSE)
  
  odbcClose(connect_db)
  
  colnames(treesa3a4) <- str_to_lower(colnames(treesa3a4))

  return(treesa3a4)
}

get_treesa2 <- function(db = db_fieldmap_foresthab){

  query_trees_a2 <- "
  SELECT DOORGROEIENDE_VERJONGING.IDPLOTS as plot_id,
  qTreeSpecies.VALUE1 as name_nl,
  DOORGROEIENDE_VERJONGING.NUMBER as n_individuals
  FROM DOORGROEIENDE_VERJONGING
  LEFT JOIN QTREESPECIES ON DOORGROEIENDE_VERJONGING.SPECIES = QTREESPECIES.ID;"

   
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  trees_a2 <- sqlQuery(connect_db, query_trees_a2)
  
  odbcClose(connect_db)
  
  colnames(trees_a2) <- str_to_lower(colnames(trees_a2))

  return(trees_a2)

}
    
get_logs <- function(db = db_fieldmap_foresthab){

  query_logs <- "
    SELECT LIM_data.IDPlots as plot_id, 
    LIM_data.IDLine_intersect_method, 
    LIM_data.Diameter_cm, 
    LIM_data.Angle_degrees
    FROM LIM_data;
  "
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  logs <- sqlQuery(connect_db, query_logs, stringsAsFactors = FALSE)

  odbcClose(connect_db)
  
  colnames(logs) <- str_to_lower(colnames(logs))
  
  return(logs)
  
}

        
```

## Functions to access forest hab fieldmap database - past2020

```{r}
get_status_foresthab_past2000 <- function(db = db_fieldmap_foresthab_past2020){

  query_invcycle <- "
    SELECT invcycle.IDPlots as plot_id,
    invcycle.edit_date as date_status,
    qplotstatus.value1 as plotstatus,
    qaccessibility.value1 as accessibility,
       invcycle.remark,
    g.veg_done,
    g.reg_done,
    g.dendro_done,
    g.springveg,
    g.info_springveg,
    g.remark4,
    qHabitat.value1 as habitat_target
    FROM invcycle
    LEFT JOIN qplotstatus ON invcycle.plotstatus = qplotstatus.id
    LEFT JOIN qaccessibility ON invcycle.accessibility = qaccessibility.id
    LEFT JOIN grid_points g on g.plot_id = invcycle.idplots
    LEFT JOIN qHabitat on qHabitat.id = g.bwk_habitat;
  "
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  plot_status <- sqlQuery(connect_db, query_invcycle, stringsAsFactors = FALSE) %>%
    unique()

  odbcClose(connect_db)
  
  colnames(plot_status) <- str_to_lower(colnames(plot_status))
  
   plot_status <- plot_status %>%
    mutate(habitat_target = gsub(" ", "_", habitat_target))
  
  return(plot_status)
  
}

get_type_observed_foresthab_past2000 <- function(db = db_fieldmap_foresthab_past2020){

  query_type_observed <- "
  SELECT Standdescription_segments_3.idplots as plot_id,
  Standdescription_segments_3.ID as segment_id,
  Standdescription_segments_3.Area_m2,
  Standdescription_segments_3.edit_date as date_standdescription,
  qHABITAT.Value1 as type_observed_circle,
  qstanddescr_Landuse.Value1 as landuse
  FROM Standdescription_segments_3
  LEFT JOIN plots ON Standdescription_segments_3.IDPlots = plots.ID
  LEFT JOIN qHABITAT ON plots.HABITAT = qHABITAT.ID 
  LEFT JOIN qstanddescr_Landuse ON Standdescription_segments_3.Landuse = qstanddescr_Landuse.ID;
  "

 connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

 type_observed_orig <- sqlQuery(connect_db, query_type_observed, stringsAsFactors = FALSE)

  odbcClose(connect_db)

  colnames(type_observed_orig) <- str_to_lower(colnames(type_observed_orig))
  
  type_observed <- type_observed_orig %>%
    mutate(type_observed_circle = ifelse(nchar(type_observed_circle) %in% c(7, 8),
                                         gsub(" ", "_", type_observed_circle),
                                         type_observed_circle))

  result <- type_observed

  return(result)
}

get_date_foresthab_past2020 <- function(db = db_fieldmap_foresthab_past2020){

  query_date_veg <- "SELECT
  IDPlots as plot_id,
  date_vegetation
  FROM Observer_date_veg_3"
  
   query_date_dendro <- "SELECT
  IDPlots as plot_id,
  date_dendro
  FROM Observer_date_dendro_3"

  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  observer_date_veg <- sqlQuery(connect_db, query_date_veg)
  observer_date_dendro <- sqlQuery(connect_db, query_date_dendro)

  odbcClose(connect_db)
  
  observer_date <- observer_date_veg %>%
      full_join(observer_date_dendro, by =  "PLOT_ID") %>%
      unique()
  
  colnames(observer_date) <- str_to_lower(colnames(observer_date))
  
  observer_date_1 <- observer_date %>%
      group_by(plot_id) %>%
      summarise(n = n(),
                date_vegetation = as.Date(ifelse(n() > 1, min(date_vegetation, na.rm = TRUE), date_vegetation)),
                date_dendro = as.Date(ifelse(n() > 1, min(date_dendro, na.rm = TRUE), date_dendro))) %>%
      ungroup()
  
  return(observer_date_1)
}


get_treesa3a4_past2020 <- function(db = db_fieldmap_foresthab_past2020){

  query_trees_past2020  <- "
  SELECT Trees_3.IDPlots as plot_id,
  Trees_3.IDSTANDDESCRIPTION_SEGMENTS_3 as segment_id,
  Trees_3.Perimeter_cm,
  Trees_3.DBH_mm,
  Trees_3.Height_m,
  Trees_3.BASALAREA_M2,
  Trees_3.VOL_STEM_M3,
  Trees_3.VOL_TOT_M3,
  qTreeSpecies.Value1 as name_nl,
  qStatusTree.Value1 as status_tree,
  qCoppice_Individual.Value1 as coppice_individual,
  qIntactTree.Value1 as intact_tree
  FROM Trees_3 
  LEFT JOIN qTreeSpecies ON Trees_3.Species = qTreeSpecies.ID
  LEFT JOIN qStatusTree ON Trees_3.Status_tree = qStatusTree.ID
  LEFT JOIN qCoppice_Individual ON Trees_3.CodeCoppice_Individual = qCoppice_Individual.ID
  LEFT JOIN qIntactTree ON Trees_3.IntactTree = qIntactTree.ID;
  "
  
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))
  
  treesa3a4 <- sqlQuery(connect_db, query_trees_past2020 , stringsAsFactors = FALSE)
  
  odbcClose(connect_db)
  
  colnames(treesa3a4) <- str_to_lower(colnames(treesa3a4))

  return(treesa3a4)
}

get_cover_species_foresthab_past2020 <- function(db = db_fieldmap_foresthab_past2020){

  query_herblayer<-"SELECT Herblayer_3.IDPlots as plot_id,
  Herblayer_3.Species as name_id,
  qVEG_HerbSpecies.Value1 as name_nl,
  qVEG_HerbSpeciesScientific.Value1 as name_sc,
  Herblayer_3.Coverage_date1 as class_id
  FROM Herblayer_3
  LEFT JOIN qVEG_HerbSpecies ON Herblayer_3.Species = qVEG_HerbSpecies.ID
  LEFT JOIN qVEG_HerbSpeciesScientific ON Herblayer_3.Species_scientific = qVEG_HerbSpeciesScientific.ID;
  "

  query_shrublayer <- "
  SELECT shrublayer_3.IDPlots as plot_id,
  shrublayer_3.Species as name_id,
  qVEG_TreeSpecies.Value1 as name_nl,
  qVEG_TreeSpeciesScientific.Value1 as name_sc,
  shrublayer_3.Coverage as class_id
  FROM shrublayer_3
  LEFT JOIN qVEG_TreeSpecies ON shrublayer_3.Species = qVEG_TreeSpecies.ID
  LEFT JOIN qVEG_TreeSpeciesScientific ON shrublayer_3.Species_Scientific = qVEG_TreeSpeciesScientific.ID;
  "

  query_treelayer <- "
  SELECT Treelayer_3.IDPlots as plot_id,
  Treelayer_3.Species as name_id,
  qVEG_TreeSpecies.Value1 as name_nl,
  qVEG_TreeSpeciesScientific.Value1 as name_sc,
  Treelayer_3.Coverage as class_id
  FROM Treelayer_3
  LEFT JOIN qVEG_TreeSpecies ON Treelayer_3.Species = qVEG_TreeSpecies.ID
  LEFT JOIN qVEG_TreeSpeciesScientific ON Treelayer_3.Species_Scientific = qVEG_TreeSpeciesScientific.ID;
  "
  
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  herblayer_orig <- sqlQuery(connect_db, query_herblayer, stringsAsFactors = FALSE)
  shrublayer_orig <- sqlQuery(connect_db, query_shrublayer, stringsAsFactors = FALSE)
  treelayer_orig <- sqlQuery(connect_db, query_treelayer, stringsAsFactors = FALSE)

  odbcClose(connect_db)

   herblayer <- herblayer_orig %>%
     mutate(layer = "herblayer")

   shrublayer <- shrublayer_orig %>%
     mutate(layer = "shrublayer")

   treelayer <- treelayer_orig %>%
     mutate(layer = "treelayer")

  #coverscales <- read_vc(file = "coverscales_mhq", root = "../../data")
   
  veglayers <- bind_rows(herblayer, shrublayer, treelayer) 
  
  colnames(veglayers) <- str_to_lower(colnames(veglayers))
  
  veglayers <- veglayers %>%
    filter(!is.na(name_id)) %>%
    mutate(coverscale_name = "Braun-Blanquet") %>%
    left_join(coverscales, by = c("coverscale_name", "class_id")) %>%
    select(plot_id, layer, name_nl, name_sc, coverscale_name, cover_description, cover_mean) %>%
    arrange(plot_id, layer, name_sc)
    
  return(veglayers)

}

get_cover_veglayers_foresthab_past2020 <- function(db = db_fieldmap_foresthab_past2020){

  query_veglayers <- "SELECT
  Vegetation_3.IDPlots as plot_id,
  Vegetation_3.ID as segment_id,
  Vegetation_3.Total_herb_cover as herblayer,
  Vegetation_3.Total_moss_cover as mosslayer,
  Vegetation_3.Total_shrub_cover as shrublayer,
  Vegetation_3.Total_tree_cover as treelayer
  FROM Vegetation_3;"

  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  veglayers_orig <- sqlQuery(connect_db, query_veglayers, stringsAsFactors = FALSE)

  odbcClose(connect_db)

  colnames(veglayers_orig) <- str_to_lower(colnames(veglayers_orig))
  
  #coverscales <- read_vc(file = "coverscales_mhq", root = "../../data")
  
  veglayers <- veglayers_orig %>%
    gather(herblayer, shrublayer, treelayer, mosslayer, key = "layer", value = "class_id") %>%
    mutate(coverscale_name = "CoverVeglayers") %>%
    left_join(coverscales, by = c("coverscale_name", "class_id")) %>%
    select(plot_id, segment_id, layer, cover_description, cover_mean) %>%
    arrange(plot_id, segment_id) 
  
  return(veglayers)

}

get_treesa2_past2020 <- function(db = db_fieldmap_foresthab_past2020){

  query_trees_a2 <- "
  SELECT DOORGROEIENDE_VERJONGING_3.IDPLOTS as plot_id,
  qTreeSpecies.VALUE1 as name_nl,
  DOORGROEIENDE_VERJONGING_3.NUMBER as n_individuals
  FROM DOORGROEIENDE_VERJONGING_3
  LEFT JOIN QTREESPECIES ON DOORGROEIENDE_VERJONGING_3.SPECIES = QTREESPECIES.ID;"

   
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  trees_a2 <- sqlQuery(connect_db, query_trees_a2)
  
  odbcClose(connect_db)
  
  colnames(trees_a2) <- str_to_lower(colnames(trees_a2))

  return(trees_a2)

}
    
get_logs_past_2020 <- function(db = db_fieldmap_foresthab_past2020){

  query_logs <- "
    SELECT LIM_data_3.IDPlots as plot_id, 
    LIM_data_3.IDLine_intersect_method_3, 
    LIM_data_3.Diameter_cm, 
    LIM_data_3.Angle_degrees
    FROM LIM_data_3;
  "
  connect_db <- odbcDriverConnect(paste("DRIVER={Firebird/InterBase(r) driver};UID=SYSDBA;PWD=masterkey; DBNAME=", db))

  logs <- sqlQuery(connect_db, query_logs, stringsAsFactors = FALSE)

  odbcClose(connect_db)
  
  colnames(logs) <- str_to_lower(colnames(logs))
  
  return(logs)
  
}
```


# Access data

```{r AccessData}

# sample_status
sample_status_openhab <- get_status_openhab() %>%
    mutate(db = "openhab")

sample_status_foresthab_orig <- get_status_foresthab() %>%
    mutate(db = "foresthab")

sample_status_foresthab <- sample_status_foresthab_orig %>%
  mutate(status_fieldwork = ifelse(is.na(info_status_fieldwork), "Opname volledig uitgevoerd",
                                ifelse(info_status_fieldwork == "Geen opname : geen doelhabitat", "Niet van toepassing",
                                        ifelse(info_status_fieldwork %in% c("Geen opname : geen toelating",
                                                                            "Geen opname : permanent nt toegankelijk",
                                                                            "Geen opname : tijdelijk nt toeg"), "Geen opname uitgevoerd",
                                               ifelse(info_status_fieldwork == "Geen (volledig) terreinbezoek uitgevoerd", "Opname gedeeltelijk uitgevoerd", NA)))),
         info_status_fieldwork = ifelse(is.na(info_status_fieldwork), "100% afgewerkt",
                                       ifelse(info_status_fieldwork == "Geen opname : geen doelhabitat", "nvt - geen doelhabitat", 
                                            ifelse(info_status_fieldwork %in% c("Geen opname : geen toelating", "Geen opname : permanent nt toegankelijk"), "geen toestemming/geen toegang (eigenaar/hond/vee)",
                                                   ifelse(info_status_fieldwork == "Geen opname : tijdelijk nt toeg", "opname tijdelijk onmogelijk (gemaaid/te nat/ondoordringbaar)", "opname nog niet 100% klaar")))))

sample_status_foresthab_past2020_orig <- get_status_foresthab_past2000() %>%
    mutate(db = "foresthab_past2020")

# information on sample_status is missing

trees_past2020 <- get_treesa3a4_past2020()
veg_past2020 <- get_cover_species_foresthab_past2020()
type_observd_past2020 <- get_type_observed_foresthab_past2000()
date_assessment_past2020 <- get_date_foresthab_past2020()

sample_status_foresthab_past2020 <- sample_status_foresthab_past2020_orig %>%
  mutate(dendro_record = plot_id %in% trees_past2020$plot_id,
         cover_species_record = plot_id %in% veg_past2020$plot_id) %>%
  left_join(select(type_observd_past2020, plot_id, type_observed_circle), by = "plot_id") %>%
  left_join(date_assessment_past2020, by = "plot_id") %>%
  mutate(remark = str_trim(remark),
         info_status_fieldwork = ifelse(dendro_record & cover_species_record, "100% afgewerkt",
                                        ifelse(dendro_record | cover_species_record, "opname nog niet 100% klaar",
                                               ifelse(type_observed_circle != habitat_target & !is.na(type_observed_circle) & type_observed_circle != "onbekend", "Geen opname : geen doelhabitat", 
                                                      ifelse(remark %in% c("Geen toelating", "DIEPE,STEILE  OEVERRAND VN BRONBEEK", "hoge afsluiting", "omheind", "Volledig omheind ,afgesloten. Jammer.", "Opname op zicht,pvlk niet toegangkelijk. Knappe veg."), "geen toestemming/geen toegang (eigenaar/hond/vee)",
                                               ifelse(remark %in% c("Hoge waterstand.", "Volledig onder wster.", "Onder water", "Ook niet met lieslaarzen."), "opname tijdelijk onmogelijk (gemaaid/te nat/ondoordringbaar)", NA)))))) %>%
  select(plot_id, date_status, info_status_fieldwork, veg_done, reg_done, dendro_done, info_springveg, springveg, remark4, remark, db) %>%
  filter(!is.na(info_status_fieldwork))

sample_status <- bind_rows(sample_status_openhab, 
                           sample_status_foresthab,
                           sample_status_foresthab_past2020)

# sample_status <- sample_status_openhab

check <- sample_status %>%
    group_by(plot_id) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1) # dit zijn plots die in 2 bewegingen zijn afgewerkt - geen fout in data

sample_status_most_recent <- sample_status %>%
    group_by(plot_id, sampling_unit_code, db) %>%
      filter(date_status == max(date_status)) %>%
    ungroup()

check <- sample_status_most_recent %>%
    group_by(plot_id) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1)

check_plot_id_missing <- sample_status %>%
  filter(is.na(plot_id))

# type_observed

type_observed <- get_type_observed_openhab() %>%
    bind_rows(get_type_observed_foresthab()) %>%
    bind_rows(get_type_observed_foresthab_past2000()) %>%
  mutate(landuse = ifelse(str_detect(landuse, "andere"), "andere", landuse))

check <-  type_observed %>%
    group_by(plot_id, type_observed_circle, type_observed_square, landuse) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1)

# bedekking van segmenten met hetzelfde habitattype sommeren
type_observed_corr <- type_observed %>%
    unique() %>%
    group_by(plot_id, type_observed_circle, type_observed_square, landuse) %>%
    summarise(segment_id = segment_id[1],
              area_m2 = sum(area_m2)) %>%
    ungroup() %>%
    group_by(plot_id) %>%
    mutate(n_segments = n()) %>%
    ungroup() %>%
    mutate(type_observed_cover_circle = round(ifelse(is.na(area_m2) & n_segments == 1, 100, 100 * area_m2/(pi*18^2)), 0)) %>%
    select(-area_m2, -n_segments)

check <-  type_observed_corr %>%
    group_by(plot_id, type_observed_circle, type_observed_square, landuse) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1)

# veglayers

cover_veglayers <- get_cover_veglayers_openhab() %>%
    bind_rows(get_cover_veglayers_foresthab()) %>%
    bind_rows(get_cover_veglayers_foresthab_past2020())

#species

cover_species <- get_cover_species_openhab() %>%
    bind_rows(get_cover_species_foresthab()) %>%
    bind_rows(get_cover_species_foresthab_past2020())

# structure_vars

structure_vars_heath <- get_measurements_heath_circle()

structure_vars_6510 <- get_measurements_6510_circle()

structure_vars <- bind_rows(structure_vars_heath, structure_vars_6510)

check <- structure_vars_heath %>%
    group_by(plot_id, segment_id, structure_var) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1)

# trees a3a4

trees_a3a4 <- get_treesa3a4_raw() %>%
  bind_rows(get_treesa3a4_past2020())


# trees a2

trees_a2 <- get_treesa2() %>%
  bind_rows(get_treesa2_past2020())

logs <- get_logs() %>%
  bind_rows(get_logs_past_2020())

# date

date_assessment_forest <- get_date_foresthab() %>%
    bind_rows(get_date_foresthab_past2020()) %>%
    mutate(date_assessment = pmin(date_vegetation, date_dendro, na.rm = TRUE))

date_assessment <- get_date_openhab() %>%
  bind_rows(date_assessment_forest) %>%
  group_by(plot_id, date_vegetation, date_dendro) %>%
  summarise(date_assessment = max(date_assessment)) %>%
  ungroup()

check <- date_assessment %>%
  group_by(plot_id) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  filter(n > 1)

# coordinates

coordinates  <- get_coordinates_openhab() %>%
    bind_rows(get_coordinates_foresthab()) %>%
    bind_rows(get_coordinates_foresthab(db = db_fieldmap_foresthab_past2020)) %>%
    unique()

check <- coordinates %>%
  group_by(plot_id) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  filter(n > 1) # check plot 12710
```


# Check type observed

The type in the center of the plot determines if the sampling unit should be measured or not.

The type is recorded in the square plot and the circle plot.

We assume that the type in the center of the plot corresponds with the type recorded in the square plot. If the type in the square plot is missing, we assume that the type corresponds with the type recorded in the circle plot. If the circle plot is a mixed plot we assume that the segment with the lowest number contains the center of the plot.

```{r}
type_observed_plot <- type_observed_corr %>%
  mutate(type_observed_circle_description = str_c(ifelse(is.na(type_observed_cover_circle), "?", type_observed_cover_circle), "% ", type_observed_circle)) %>%
  group_by(plot_id) %>%
  mutate(type_observed_circle_description = str_c(type_observed_circle_description, collapse = "; "),
         mixed_plot = n() > 1) %>%
  slice_min(order_by = segment_id, n = 1) %>%
  ungroup() %>%
  mutate(type_observed = ifelse(!is.na(type_observed_square), type_observed_square, type_observed_circle))

check_type <- type_observed_plot %>%
  filter(mixed_plot) 

check_unique_type <- type_observed_plot %>%
  group_by(plot_id) %>%
  filter(n_distinct(type_observed) > 1)

type_observed_plot <- type_observed_plot %>%
  filter(!(plot_id == 659794 & type_observed == "infrastructuur"))

type_observed_corr <- type_observed_corr %>%
  filter(!(plot_id == 659794 & type_observed_square == "infrastructuur")) %>%
  filter(!(plot_id == 267222 & is.na(type_observed_circle)))
```

Check plot below!

```{r}
check_unique_type %>%
  datatable(filter = "top",
            rownames = FALSE)
```



In the table below we check the cases when the cover in the square plot is not recorded and when the circle plot is mixed.

```{r}
check_type %>%
    select(plot_id, type_observed, type_observed_circle_description) %>%
    datatable(filter = "top",
            rownames = FALSE)
```



# Check missing data

```{r MissingData}

cover_veglayers_plot <- cover_veglayers %>%
    group_by(plot_id) %>%
    summarise(cover_veglayer_recorded = sum(!is.na(cover_mean) | !is.na(cover)) > 0) %>%
    ungroup() %>%
    filter(cover_veglayer_recorded)

date_assessment_plot <- date_assessment %>%
    group_by(plot_id) %>%
    summarise(date_assessment = min(date_assessment)) %>%
    ungroup()

check_coordinates_double <- coordinates %>%
  group_by(plot_id) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  filter(n > 1)

types <- read_types()

check_missing_data <- sample_status_most_recent %>%
    filter(!is.na(plot_id)) %>%
    left_join(type_observed_plot, by = "plot_id") %>%
    left_join(date_assessment_plot, by = "plot_id") %>%
  #opname uitgevoerd cfr invav
    mutate( inaccessible = ifelse(!is.na(info_status_fieldwork) 
                                   & info_status_fieldwork %in% c("tijdelijk geen toestemming/geen toegang (eigenaar/hond/vee)"), "short term", 
                                  ifelse(info_status_fieldwork %in% c("geen toestemming/geen toegang (eigenaar/hond/vee)"), "long term", NA)),
            not_measurable = ifelse(!is.na(info_status_fieldwork) 
                                   & info_status_fieldwork %in% c("opname tijdelijk onmogelijk (gemaaid/te nat/ondoordringbaar)"), "short term", 
                                  ifelse(info_status_fieldwork %in% c("opname onmogelijk (gemaaid/begraasd/te nat/ondoordringbaar)"), "long term", NA)),
            assessment_source = ifelse((is.na(inaccessible) & is.na(not_measurable)) | type_observed %in% types$type | type_observed == "geen habitat (akker, houtkant, tuin,...)", "field assessment", NA),
            lsvi_measurement = info_status_fieldwork == "100% afgewerkt",
            completed = ifelse(lsvi_measurement,
                              ifelse(!is.na(info_status_fieldwork) &  info_status_fieldwork != "100% afgewerkt", FALSE, TRUE),NA),
         coordinates_record = plot_id %in% coordinates$plot_id, 
         cover_species_record = plot_id %in% cover_species$plot_id, 
         cover_veglayers_record = plot_id %in% cover_veglayers_plot$plot_id, 
         a3a4_record = ifelse(db %in% c("foresthab", "foresthab_past2020"), plot_id %in% trees_a3a4$plot_id, NA), 
         a2_record = ifelse(db %in% c("foresthab", "foresthab_past2020"), plot_id %in% trees_a2$plot_id, NA), 
         logs_record = ifelse(db %in% c("foresthab", "foresthab_past2020"), plot_id %in% logs$plot_id, NA), 
         dendro_record = a3a4_record | a2_record | logs_record, 
         structure_openhab_record = ifelse(db == "openhab" | is.na(db), plot_id %in% structure_vars$plot_id, NA)) %>%
  mutate(plot_id = as.character(plot_id))

assessments <- check_missing_data %>%
  mutate(date_assessment = if_else(is.na(date_assessment), as.Date(date_status), date_assessment)) %>%
    select(plot_id, sampling_unit_code, targethabitat, status_fieldwork,info_status_fieldwork, assessment_source, date_assessment, inaccessible, not_measurable, type_observed,  lsvi_measurement, remark, structure_openhab_record, cover_species_record, dendro_record) %>%
  filter(!(is.na(assessment_source) & is.na(inaccessible) & is.na(not_measurable)))

check <- assessments %>%
  group_by(sampling_unit_code) %>%
  filter(n() > 1 )

```

## Measured open habitat plot with missing data 

A plot is regarded as measured when targethabitat = "ja" and status_fieldwork = "100% afgewerkt" (v7 db open).

Possible actions:

- When all vegetation and structure records are missing: 
    - change 'status_fieldwork' and/or 'info_status_fieldwork'

- When vegetation or structure is missing
    - change 'status_fieldwork' to 'Opname gedeeltelijk uitgevoerd'

- Check date_assessments or coordinates when missing and add them if possible


```{r}
check_missing_data_openhab <- check_missing_data %>%
    filter(db == "openhab") %>%
    filter(lsvi_measurement) %>%
    filter(is.na(type_observed_circle) |
               is.na(date_assessment) |
               !coordinates_record |
               !cover_species_record |
               !structure_openhab_record) %>%
    select(plot_id, status_fieldwork, info_status_fieldwork, remark, type_observed_circle, date_assessment, coordinates_record, cover_species_record, structure_openhab_record) 

check_missing_data_openhab %>%
    datatable(filter = "top",
            rownames = FALSE, options = list(pageLength = 30))


```


```{r eval=FALSE, include=FALSE}
# corrections -> to be changed in database!

change_geen_habitat <- check_missing_data_openhab %>%
   filter(type_observed_circle == "geen habitat (akker, houtkant, tuin,...)" & is.na(info_status_fieldwork))


sample_status <- sample_status %>%
  mutate(status_fieldwork = ifelse(plot_id == "1287030", "nee", as.character(status_fieldwork)),
         info_status_fieldwork = ifelse(plot_id == "1287030", "Geen (volledig) terreinbezoek uitgevoerd", as.character(info_status_fieldwork)))

```


## Not measured open habitat plot with data


A plot is regarded as not measured when 'targethabitat' = 'onbekend' or 'nee' or targethabitat = 'ja' and ('status_fieldwork' = 'geen opname gevraagd' or 'geen opname uitgevoerd' or 'opname gedeeltelijk uitgevoerd'). 

Possible actions:

- When all vegetation and structure records are recorded:
    - adjust 'info_status_fieldwork' and 'status_fieldwork'

- When vegetation and structure records are partially recorded:
    - check 'info_status_fieldwork' 

```{r missingDataOpen2}
check_missing_data_openhab2 <- check_missing_data %>%
    filter(db == "openhab" | is.na(db)) %>%
  #  filter(!lsvi_measurement | status_fieldwork == "nee" | is.na(status_fieldwork)) %>%
    filter( targethabitat != 'ja' |  (targethabitat == 'ja' & status_fieldwork %in% c("Geen opname gevraagd", "Geen opname uitgevoerd", "Opname gedeeltelijk uitgevoerd")) ) %>%
    filter(cover_species_record |
               structure_openhab_record) %>%
    select(plot_id, status_fieldwork, info_status_fieldwork, remark, type_observed_circle, date_assessment, cover_species_record, structure_openhab_record) 

check_missing_data_openhab2 %>%
    datatable(filter = "top",
            rownames = FALSE)
```



## Overview of assessments

```{r summaryOpen}

targetYes <- check_missing_data %>%
    filter(targethabitat == 'ja') %>%
    group_by(targethabitat, status_fieldwork, info_status_fieldwork, assessment_source, inaccessible, lsvi_measurement, completed) %>%
    summarise(count = n()) %>%
    ungroup()

targetNo <- check_missing_data %>%
    filter(targethabitat != 'ja') %>%
    group_by(targethabitat, status_fieldwork, info_status_fieldwork, assessment_source, inaccessible, lsvi_measurement, completed) %>%
    summarise(count = n()) %>%
    ungroup()

rbind(targetYes, targetNo) %>%
    datatable(filter = "top",
            rownames = FALSE)

```


## Measured forest plot with missing data 

A plot is regarded as measured when 'status_fieldwork' = 'ja' and 'info_status_fieldwork' = NA.

Possible actions:

- When all vegetation and dendro records are missing: two options
    - change 'info_status_fieldwork' to 'Geen opname: geen doelhabitat' when the target habitat type (or another valid type) was not observed
    - change 'status_fieldwork' to 'nee' when the plot has not been visited yet

- When vegetation is missing
    - change 'info_status_fieldwork' to 'Geen (volledig) terreinbezoek uitgevoerd'

- When dendro records are missing
    - Check if there were no trees in the plot
    
- When only date assessment is missing
    - Add date assessment


```{r MissingDataForest}
check_missing_data_foresthab <- check_missing_data %>%
    filter(db == "foresthab") %>%
    filter(lsvi_measurement) %>%
    filter(is.na(type_observed_circle) |
               is.na(date_assessment) |
               !cover_species_record |
               !dendro_record |
               !a2_record) %>%
    select(plot_id, status_fieldwork, info_status_fieldwork, remark, type_observed_circle, date_assessment, cover_species_record, dendro_record, a2_record, a3a4_record) 

check_missing_data_foresthab %>%
  datatable(filter = "top",
            rownames = FALSE)

```

## Not measured forest habitat plot with data

A plot is regarded as not measured when 'status_fieldwork' = 'nee' or when 'info_status_fieldwork' is not NA.

Possible actions:

- When all vegetation and structure records are recorded:
    - set 'info_status_fieldwork' to NA

- When vegetation and structure records are partially recorded:
    - check 'info_status_fieldwork' 

```{r MissingDataForest2}
check_missing_data_foresthab2 <- check_missing_data %>%
    filter(db == "foresthab") %>%
    filter(!lsvi_measurement | status_fieldwork == "nee") %>%
    filter(cover_species_record |
               dendro_record) %>%
    select(plot_id, status_fieldwork, info_status_fieldwork, remark, type_observed_circle, date_assessment, cover_species_record, dendro_record, a2_record, a3a4_record) 

check_missing_data_foresthab2 %>%
  datatable(filter = "top",
            rownames = FALSE)
```

## Plots with status_fieldwork == "nee" & info_status_fieldwork == "Geen opname : geen doelhabitat"

```{r MissingDataForest3}
check_missing_data_foresthab3 <- check_missing_data %>%
    filter(db == "foresthab" | is.na(db)) %>%
    filter(status_fieldwork == "nee" & info_status_fieldwork == "Geen opname : geen doelhabitat") %>%
    select(plot_id, status_fieldwork, info_status_fieldwork, remark, type_observed_circle, date_assessment, cover_species_record, structure_openhab_record) 

check_missing_data_foresthab3 %>%
    datatable(filter = "top",
            rownames = FALSE)
```

# Write result to .vc file


```{r write}

sample_status_date <- sample_status_most_recent %>%
  left_join(select(date_assessment, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything()) %>%
  mutate(date_status = as.Date(date_status, format = "%Y-%m-%d"),
         date_assessment = if_else(is.na(date_assessment), date_status, date_assessment)) %>%
  select(-navplot_id, -remark4, -springveg, -veg_done, -reg_done, -dendro_done, -info_springveg)

check_double <- sample_status_date %>%
  group_by(plot_id) %>%
  filter(n() > 1)

type_observed_date <- type_observed_corr %>%
  unique() %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, segment_id, date_assessment, everything())

check <- type_observed_date %>%
  group_by(plot_id, segment_id) %>%
  filter(n() > 1)

cover_species_date <- cover_species %>%
  mutate(name_sc = ifelse(name_nl == "Tormentil", "Potentilla erecta (L.) Ruschel", name_sc),
         name_sc = ifelse(name_nl == "Valse voszegge", "Carex cuprina (Sndor ex Heuffel) Nendtvich ex A. Kerner", name_sc)) %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything())

check <- cover_species_date %>%
  group_by(plot_id, layer, name_nl) %>%
  filter(n() > 1)

cover_veglayers_date <- cover_veglayers %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything())

check <- cover_veglayers_date %>%
  group_by(plot_id, segment_id, layer) %>%
  filter(n() > 1)

structure_vars_date <- structure_vars %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything())

check <- structure_vars_date %>%
  group_by(plot_id, segment_id, structure_var) %>%
  filter(n() > 1)

coordinates_date <- coordinates %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything()) %>%
  select(-idplots) 

check <- coordinates_date %>%
  group_by(plot_id) %>%
  filter(n() > 1)

logs_date <- logs %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything()) 

trees_a3a4_date <- trees_a3a4 %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, segment_id, tree_id, date_assessment, everything()) 

check <- trees_a3a4_date %>%
  group_by(plot_id, segment_id, tree_id) %>%
  filter(n() > 1)

trees_a2_date <- trees_a2 %>%
  inner_join(select(sample_status_date, plot_id, date_assessment), by = "plot_id") %>%
  select(plot_id, date_assessment, everything()) 


path <- str_c(fileman_up("n2khab-mhq-data"), "/processed")

if (!dir.exists(path)) {
    
  dir.create(path)  
    
}

path <- str_c(fileman_up("n2khab-mhq-data"), "/processed/fieldmap_mhq")

if (!dir.exists(path)) {
    
  dir.create(path)  
    
}

write_vc(sample_status_date, "sample_status", root = path,  sorting = c("plot_id", "date_assessment"), strict = FALSE)
write_vc(type_observed_date, "type_observed", root = path,  sorting = c("plot_id", "segment_id", "date_assessment", "type_observed_circle", "type_observed_square"), strict = FALSE)
write_vc(cover_veglayers_date, "cover_veglayers", root = path,  sorting = c("plot_id", "segment_id", "date_assessment", "layer"), strict = FALSE)
write_vc(cover_species_date, "cover_species", root = path,  sorting = c("plot_id", "date_assessment", "layer", "name_nl"), strict = FALSE)
write_vc(structure_vars_date, "structure_vars", root = path,  sorting = c("plot_id", "segment_id", "date_assessment",  "structure_var"), strict = FALSE)
write_vc(date_assessment, "date_assessment", root = path,  sorting = ("plot_id"))
write_vc(coordinates_date, "coordinates", root = path,  sorting = c("plot_id", "date_assessment"), strict = FALSE)
write_vc(trees_a3a4_date, "trees_a3a4", root = path,  sorting = c("plot_id", "segment_id", "date_assessment"), strict = FALSE)
write_vc(trees_a2_date, "trees_a2", root = path,  sorting = c("plot_id", "date_assessment", "name_nl"), strict = FALSE)
write_vc(logs_date, "logs", root = path,  sorting = c("plot_id", "date_assessment", "idline_intersect_method"), strict = FALSE)
write_vc(check_missing_data, root = path,  "data_overview", sorting = "plot_id", strict = FALSE)
write_vc(assessments, root = path,  "assessments", sorting = c("plot_id", "date_assessment"), strict = FALSE)
write_vc(check_missing_data_foresthab, root = path,  "check_missing_data_foresthab", sorting = "plot_id")
write_vc(check_missing_data_openhab, root = path,  "check_missing_data_openhab", sorting = "plot_id")

```

