---
title: "data cleanup of survey HT3260 (inboveg database)"
author: "An Leyssen"
date: "`r lubridate::now()`"
output: 
  html_document:
    number_sections: yes
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(git2rdata)
library(n2khab)
```

# import data

```{r}
path <- str_c(fileman_up("n2khab-mhq-data"), "/processed/inboveg_mhq_aq")

classif_mhq_aq <- read_vc("classif_mhq_aq", root = path)
header_mhq_aq <- read_vc("header_mhq_aq", root = path)
structure_mhq_aq <- read_vc("structure_mhq_aq", root = path)
sitequal_mhq_aq <- read_vc("sitequal_mhq_aq", root = path)
layerqual_mhq_aq <- read_vc("layerqual_mhq_aq", root = path) 
vegetation_mhq_aq <- read_vc("vegetation_mhq_aq", root = path)

# to do bij qualifiers_m_mhq.Rmd: 
# opvolgen of Q3Code %in% c("SStr", "SDiep") ondertussen een Q3Description heeft
# opmerkingen uit inboveg toevoegen aan header (maar wellicht niet mogelijk via bestaande functies?)

```

# filter survey HT3260

```{r}
this_survey <- "HT3260"

classif_3260 <- classif_mhq_aq %>% filter(survey == this_survey)
header_3260 <- header_mhq_aq %>% filter(survey == this_survey)
structure_3260 <- structure_mhq_aq %>% filter(survey == this_survey)
sitequal_3260 <- sitequal_mhq_aq %>% filter(survey == this_survey)
layerqual_3260 <-  layerqual_mhq_aq %>% filter(survey == this_survey)
vegetation_3260 <- vegetation_mhq_aq %>% filter(survey == this_survey)
```

# data cleaning

the dataset is rearranged into:  
- header data 
- site characteristics  
- vegetation data  

## header data
= collection of header, classif and site qualifiers (betrouwbaarheid + reden geen opname)

```{r}
details_no_survey <- sitequal_3260 %>% 
  filter(!(is.na(comment))) %>% 
  select(recording_givid, comment_not_measured = comment) 

sitequal <- sitequal_3260 %>% 
  select(-comment, -value_code) %>%
  mutate(var = case_when(
    str_detect(value, "Betrouwbaarheid opname:") ~ "reliability",
    str_detect(value, "Geen opname:") ~ "reason_no_survey")) %>% 
  spread(key = var, value = value) %>% 
  left_join(details_no_survey, by = "recording_givid") %>% 
  mutate(reliability = str_remove(reliability, "Betrouwbaarheid opname: "),
         reason_no_survey = str_remove(reason_no_survey, "Geen opname: "),
         reason_no_survey = str_replace(reason_no_survey, "niet toegankelijk", "ongeschikt"), 
         comment_not_measured = ifelse(is.na(comment_not_measured),
                                      reason_no_survey,
                                      paste0(reason_no_survey, "; ", comment_not_measured)))

# identify recording_givid with no or partial measurements
no_structure <- anti_join(header_3260, structure_3260, by = "recording_givid") 
no_layers <- anti_join(header_3260, layerqual_3260, by = "recording_givid") 
no_vegetation <- anti_join(header_3260, vegetation_3260, by = "recording_givid") 
no_survey <- bind_rows(no_structure, no_layers, no_vegetation) %>% 
  distinct() 

header <- header_3260 %>% 
  left_join(select(classif_3260, recording_givid, type_observed, classif_key), 
            by = "recording_givid") %>% 
  mutate(type_observed = factor(type_observed, 
                                  levels = c("-9", "0", "3260"),
                                  labels = c("gh", "unknown", "3260"))) %>% 
  left_join(sitequal, by = c("survey", "recording_givid", "user_reference")) %>% 
  mutate(suitable_mhq = ifelse(test = (type_observed == "3260" & is.na(reason_no_survey)), 
                          yes = TRUE,
                          no = FALSE),
         measured = ifelse(test = recording_givid %in% no_survey$recording_givid,
                         yes = FALSE,
                         no = TRUE)) %>% 
  select(recording_givid, survey, user_reference, location, date = vague_date_begin, 
         latitude, longitude, type_observed, reliability, suitable_mhq, measured, comment_not_measured)

```

type_observed:  
0: niet genoteerd; unknown  
-9: geen habitat; gh  

'measured' (TRUE/FALSE): geeft aan of er al dan niet een opname is gebeurd; een onvolledige opname (geen structuur- layer- of vegetatieknemerken genoteerd) wordt als FALSE beschouwd  

suitable_mhq (TRUE/FALSE): TRUE indien type observed = 3260 EN reason no survey is niet opgegeven  

comment_not_measured = permanent ongeschikt e.d.  

overige kenmerken en interpretaties van variabelen: zie veldprotocol (SVP-403)  

## site characteristics
= collection of structure and layer qualifiers  

### structure
```{r}
var_class <- c("profl", "profr", "peil") # peil partim waterpeil
var_multiple <- c("beh", "orgma", "artif", "turbi", "wijze") # turbi: excl Secchi
var_num_elu <- c("dwars", "peil", "turbi", "vlek") 
        # peil partim stroomsnelheid; 
        # turbi: partim Secchi
var_num <- c("schab", "schao") 
var_minimum <- c("SlibX", "DiepX", "SeccX") # = minimum x m

structure_class_multiple <- structure_3260 %>% 
  filter(var_code %in% c(var_class, var_multiple), 
         !(var_value_code %in% c("SDiep", "SStr")), # exclude data stroomsnelheid (=numeric)
         !(var_value_code %in% c("Secch", "SeccX"))) %>% # exclude data Secchi-diepte (=numeric)
  select(survey, recording_givid, user_reference, var_code, var, 
         value = var_description_or_value) %>% 
  mutate(value_numeric = NA, is_below_LOQ = FALSE, is_above_LOQ = FALSE, 
         is_numeric = FALSE, unit = "class")

structure_num_elu <- structure_3260 %>% 
  filter(var_code %in% var_num_elu,
         !(var_value_code %in% c("Droog","Norm","UHoog","ULaag")),
         !(var_value_code %in% c("100","200","300"))) %>%
  select(survey, recording_givid, user_reference, var_code = var_value_code, 
         var = var_description_or_value, value) %>% 
  mutate(var = case_when(
           var_code == "SDiep" ~ "diepte stroomsnelheid (m)", 
           var_code == "SStr" ~ "stroomsnelheid (m/s)", # to do: schrap indien dit in description in inboveg is aangevuld voor SDiep & SStr
           var_code == "DiepX" ~ "Diepte in meter", 
           var_code == "SeccX" ~ "Secchi-diepte in m",
           var_code == "SlibX" ~ "Slibdikte in meter",
         TRUE ~ var),
         value = case_when(
           var_code %in% var_minimum ~ paste0(">", value),
           value %in% c("aanwezig", "meerdere vlekjes aanwezig") ~ ">1",
           TRUE ~ value),
         value_numeric = str_remove(value, "[<>]"),
         value_numeric = as.numeric(str_replace(value_numeric, ",", "\\."))) %>% 
  filter(!is.na(value_numeric)) %>% 
  mutate(is_below_LOQ = FALSE, # to do: aanpassen indien wel waarden <
         is_above_LOQ = ifelse(test = str_starts(value, ">"),
                               yes = TRUE, no = FALSE), 
         is_numeric = TRUE,
         unit = case_when(
           var_code %in% c("Breed", "Diep", "DiepX", "Lang", "SDiep", "Secch", 
                           "SeccX", "Slib","SlibX") ~ "m",
           var_code == "SStr" ~ "m/s",
           var_code %in% c("MaxGr", "Som") ~ "mÂ²",
           TRUE ~ "count"))

structure_num <- structure_3260 %>% 
  filter(var_code %in% var_num) %>% 
  mutate(value = case_when(
           var_value_code == "0-x-1" ~ "<1",
           TRUE ~ var_value_code),
         value_numeric = str_remove(value, "[<>]"),
         value_numeric = as.numeric(value_numeric)) %>% 
  select(survey, recording_givid, user_reference, var_code, var, value, value_numeric) %>% 
  mutate(is_below_LOQ = ifelse(test = str_starts(value, "<"),
                               yes = TRUE, no = FALSE), 
         is_above_LOQ = FALSE, # to do: aanpassen indien wel waarden >
         is_numeric = TRUE,
         unit = "%")

structure_artif_m <- structure_3260 %>% 
  filter(var_code == "artif",
        var_description_or_value %in% c("Brug", "Bodemplaat of -val", "Duiker")) %>% 
  mutate(var_code = var_value_code,
         var = paste0("lengte ", var_description_or_value),
         value_numeric = str_remove(value, "[<>]"),
         value_numeric = as.numeric(str_replace(value_numeric, ",", "\\."))) %>% 
  filter(!is.na(value_numeric)) %>% 
  select(survey, recording_givid, user_reference, var_code, var, value, value_numeric) %>% 
  mutate(is_below_LOQ = ifelse(test = str_starts(value, "<"),
                               yes = TRUE, no = FALSE), 
         is_above_LOQ = FALSE, # to do: aanpassen indien wel waarden >
         is_numeric = TRUE,
         unit = "m")

structure <- bind_rows(structure_class_multiple, structure_num_elu, 
                       structure_num, structure_artif_m)
```

beschrijving van enkele variabelen:  
- SDiep: diepte stroomsnelheidsbepaling (m)   
- SStr: stroomsnelheid (m/s)  
- Secchi-diepte in m: bepaling doorzicht adhv meting met Secchi-schijf (zie protocol SVP-403)  
- Secchi-diepte meer dan (m): indien exacte bepaling niet mogelijk is, wordt dit genoteerd als > x m (vnl owv veiligheid; zie protocol)  
- Slib meer dan (m): indien exacte bepaling slibdikte niet mogelijk is (owv veiligheid), wordt dit genoteerd als > x m  
- Diepte meer dan (m): indien exacte bepaling waterdiepte niet mogelijk is (owv veiligheid), wordt dit genoteerd als > x m  

controle - tmp
```{r, eval=FALSE}
# tmp - to do: opvolgen of NA's in description aangevuld zijn
structure_3260 %>% 
  filter(is.na(var_description_or_value),
         !(var_value_code %in% var_stroomsnelheid)) %>% 
  select(survey, recording_givid, user_reference, var_value_code, var_description_or_value) # 1 record
```

### layerqual
```{r}
layerqual <- layerqual_3260 %>% 
  mutate(var_code = ifelse(var_code %in% c("0", "1", "2", "3"),
                           yes = paste0("sv_", var_code),
                           no = var_code),
         var = case_when(
           var_code == "sv_0" ~ "submerse vegetatie afwezig",
           var_code == "sv_1" ~ "submerse vegetatie schaars",
           var_code == "sv_2" ~ "submerse vegetatie frequent",
           var_code == "sv_3" ~ "submerse vegetatie opgevuld",
           TRUE ~ var),
         value = case_when(
           value == ".5" ~ "0.5",
           value == "0,1" ~ "0.1",
           value == "0-x-1" ~ "<1",
           value == "9X" ~ "100",
           TRUE ~ value),
         value_numeric = str_remove(value, "[<>]"),
         value_numeric = as.numeric(str_replace(value_numeric, ",", "\\."))) %>% 
  select(survey, recording_givid, user_reference, var_code, var, value, value_numeric) %>% 
  mutate(is_below_LOQ = ifelse(test = str_starts(value, "<"),
                               yes = TRUE, no = FALSE), 
         is_above_LOQ = FALSE, # to do: aanpassen indien wel waarden >
         is_numeric = TRUE,
         unit = "%")
```

controle - tmp
```{r, eval=FALSE}
layerqual_3260 %>% 
  select(value, value_perc) %>% 
  arrange(value) %>% distinct()
# to do (opvolgen): 0,1 al aangepast in inboveg door Pieter
```


### combined
= site_characteristics = structure + layer
```{r}
site_characteristics <- bind_rows(structure, layerqual) %>%
    mutate(var = str_to_lower(var),
                 value = str_to_lower(value))
```


## vegetation
rearrangement of vegetation
```{r}
vegetation <- vegetation_3260 %>% 
  mutate(name = ifelse(is.na(name_scientific), name_original, name_scientific)) %>% 
  select(survey, recording_givid, name, phenology_code, species_cover_code, species_cover, scale) %>% 
  distinct() # to do opvolgen of dubbels eruit zijn

# to do (later): nagaan of Nederlandse naam beschikbaar is in inboveg (@ Sofie of Pieter) 
```

controle - tmp
```{r, eval=FALSE}
# lijst my taxa 
vegetation_3260 %>% 
  filter(is.na(name_scientific)) %>% 
  count(name_original) %>% 
  arrange(name_original)

sel_species <- c("Enteromorpha sp.")
sel_species <- c("Salix 'alba' groep")
sel_species <- c("Poaceae", "poaceae")

vegetation_3260 %>% 
  filter(name_original %in% sel_species) %>% 
  left_join(select(header, recording_givid, user_reference), by = "recording_givid") %>% 
  select(recording_givid, user_reference, name_original, species_cover_code) 
  
# soorten van 'my taxa' uniformiseren want identiek: to do voor 2017 en 2018 (opvolgen; @ Pieter gevraagd)
#   Callitriche 'obtusangula/platycarpa' groep en Callitriche platycarpa/obtusangula   -
#   darmwier   en Enteromorpha sp.
# gras (poaceae, vegetatief, niet gedetermineerd),   gras vegetatief en Poaceae, poaceae
# mos en mos niet gedetermineerd
# Salix 'alba' groep en Salix smalbladig en wilg smal

# check of er nog dubbels zijn in vegetation
 vegetation %>%
    group_by(recording_givid,  name, phenology_code) %>%
    filter(n() > 1)
```


# data controle 
##  input
```{r, eval = FALSE}
this_sample <- "Dommel_14"

header_sel <- header_3260 %>% filter(str_detect(user_reference, this_sample))

classif_sel <- classif_3260  %>% semi_join(header_sel, by = "recording_givid")
structure_sel <- structure_3260  %>% semi_join(header_sel, by = "recording_givid")
sitequal_sel <- sitequal_3260  %>% semi_join(header_sel, by = "recording_givid")
layerqual_sel <- layerqual_3260  %>% semi_join(header_sel, by = "recording_givid")
vegetation_sel <- vegetation_3260  %>% semi_join(header_sel, by = "recording_givid")

# is ok; alles zit erin
```

##  output

```{r, eval = FALSE}
header_sel <- header %>%  
  filter(str_detect(user_reference, this_sample))

site_characteristics_sel <- site_characteristics %>% semi_join(header_sel, by = "recording_givid")
vegetation_sel <- vegetation %>% semi_join(header_sel, by = "recording_givid")

# is ok; alles zit erin
```

# data export

```{r}
write_vc(header, "HT3260_header", root = path, 
         sorting = c("recording_givid"), , strict = FALSE)
write_vc(site_characteristics, "HT3260_site_characteristics", root = path, 
         sorting = c("recording_givid", "var", "value"), strict = FALSE)
write_vc(vegetation, "HT3260_vegetation", root = path, 
         sorting = c("recording_givid", "name", "phenology_code"))
```
